#!/bin/bash
# Start and reload AeroSpace, SketchyBar, Borders, and SwipeAeroSpace

# Set MAKARON_PATH
MAKARON_PATH="${MAKARON_PATH:-$HOME/.local/share/makaron}"

echo "ðŸš€ Starting Makaron UI components..."
echo ""

# Start and enable AeroSpace
if command -v aerospace &> /dev/null; then
    if ! pgrep -f "AeroSpace" > /dev/null; then
        echo "  Starting AeroSpace..."
        open -a AeroSpace
        sleep 2
    fi
    echo "  Enabling AeroSpace..."
    aerospace enable on
    aerospace reload-config
    echo "  âœ“ AeroSpace enabled and config reloaded"
else
    echo "  âš ï¸  AeroSpace not installed"
fi

# Start SketchyBar service
if command -v sketchybar &> /dev/null; then
    if ! pgrep -f "sketchybar" > /dev/null; then
        echo "  Starting SketchyBar..."
        brew services start sketchybar
        sleep 2
    fi
    echo "  Reloading SketchyBar config..."
    sketchybar --reload
    echo "  âœ“ SketchyBar started and config reloaded"
else
    echo "  âš ï¸  SketchyBar not installed"
fi

# Compile calendar plugin if needed
CALENDAR_SOURCE_DIR="$MAKARON_PATH/configs/sketchybar/plugins/calendar"
if [ -f "$CALENDAR_SOURCE_DIR/calendar_events.swift" ] && [ ! -f "$CALENDAR_SOURCE_DIR/calendar_events" ]; then
    echo "  Compiling calendar plugin..."
    cd "$CALENDAR_SOURCE_DIR"
    if swiftc -o calendar_events calendar_events.swift 2>/dev/null; then
        chmod +x calendar_events
        echo "  âœ“ Calendar plugin compiled"
    else
        echo "  âš ï¸  Failed to compile calendar plugin"
    fi
    cd - > /dev/null
fi

# Start Borders with theme colors
if command -v borders &> /dev/null; then
    # Load theme colors
    THEME_DIR="$MAKARON_PATH/current-theme"

    if [ -f "$THEME_DIR/borders.colors" ]; then
        source "$THEME_DIR/borders.colors"
    else
        # Fallback colors
        export ACTIVE_BORDER_COLOR=0xff7aa2f7
        export INACTIVE_BORDER_COLOR=0xff292e42
        export BORDER_WIDTH=2.0
    fi

    echo "  Starting Borders with theme colors..."
    brew services stop borders 2>/dev/null || true
    sleep 0.5
    borders active_color=$ACTIVE_BORDER_COLOR inactive_color=$INACTIVE_BORDER_COLOR width=$BORDER_WIDTH &
    echo "  âœ“ Borders started with theme colors"
else
    echo "  âš ï¸  Borders not installed"
fi

# Start SwipeAeroSpace if installed
if [ -d "/Applications/SwipeAeroSpace.app" ]; then
    if ! pgrep -f "SwipeAeroSpace" > /dev/null; then
        echo "  Starting SwipeAeroSpace..."
        open -a SwipeAeroSpace
        sleep 1
        echo "  âœ“ SwipeAeroSpace started"
    else
        echo "  âœ“ SwipeAeroSpace already running"
    fi
fi

# Hide menu bar (enable autohide)
echo "  Hiding macOS menu bar..."
defaults write NSGlobalDomain _HIHideMenuBar -bool true
killall SystemUIServer 2>/dev/null || true
killall Dock 2>/dev/null || true
echo "  âœ“ Menu bar hidden (autohide enabled, may require logout/login for full effect)"

echo ""
echo "âœ… UI components started and configured. Use 'makaron-ui-stop' to disable."


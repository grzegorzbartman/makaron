#!/bin/bash
# Start and reload AeroSpace, SketchyBar, and Borders

# Set MAKARON_PATH
MAKARON_PATH="${MAKARON_PATH:-$HOME/.local/share/makaron}"

echo "ðŸš€ Starting Makaron UI components..."
echo ""

# Start and enable AeroSpace
if command -v aerospace &> /dev/null; then
    if ! pgrep -f "AeroSpace" > /dev/null; then
        echo "  Starting AeroSpace..."
        open -a AeroSpace
        sleep 2
    fi
    echo "  Enabling AeroSpace..."
    aerospace enable on
    aerospace reload-config
    echo "  âœ“ AeroSpace enabled and config reloaded"
else
    echo "  âš ï¸  AeroSpace not installed"
fi

# Start SketchyBar service
if command -v sketchybar &> /dev/null; then
    if ! pgrep -f "sketchybar" > /dev/null; then
        echo "  Starting SketchyBar..."
        brew services start sketchybar
        sleep 2
    fi
    echo "  Reloading SketchyBar config..."
    sketchybar --reload
    echo "  âœ“ SketchyBar started and config reloaded"
else
    echo "  âš ï¸  SketchyBar not installed"
fi

# Compile calendar plugin if needed
CALENDAR_SOURCE_DIR="$MAKARON_PATH/configs/sketchybar/plugins/calendar"
if [ -f "$CALENDAR_SOURCE_DIR/calendar_events.swift" ] && [ ! -f "$CALENDAR_SOURCE_DIR/calendar_events" ]; then
    echo "  Compiling calendar plugin..."
    cd "$CALENDAR_SOURCE_DIR"
    if swiftc -o calendar_events calendar_events.swift 2>/dev/null; then
        chmod +x calendar_events
        echo "  âœ“ Calendar plugin compiled"
    else
        echo "  âš ï¸  Failed to compile calendar plugin"
    fi
    cd - > /dev/null
fi

# Start Borders with theme colors
if command -v borders &> /dev/null; then
    # Load theme colors
    THEME_DIR="$MAKARON_PATH/current-theme"

    if [ -f "$THEME_DIR/borders.colors" ]; then
        source "$THEME_DIR/borders.colors"
    else
        # Fallback colors
        export ACTIVE_BORDER_COLOR=0xff7aa2f7
        export INACTIVE_BORDER_COLOR=0xff292e42
        export BORDER_WIDTH=2.0
    fi

    echo "  Starting Borders with theme colors..."
    brew services stop borders 2>/dev/null || true
    sleep 0.5
    borders active_color=$ACTIVE_BORDER_COLOR inactive_color=$INACTIVE_BORDER_COLOR width=$BORDER_WIDTH &
    echo "  âœ“ Borders started with theme colors"
else
    echo "  âš ï¸  Borders not installed"
fi

# Hide Dock (enable autohide)
echo "  Hiding macOS Dock..."
defaults write com.apple.dock autohide -bool true
echo "  âœ“ Dock hidden (autohide enabled)"

# Enable Mission Control grouping by application (AeroSpace fix)
echo "  Enabling window grouping by application..."
defaults write com.apple.dock expose-group-apps -bool true
killall Dock
echo "  âœ“ Window grouping enabled (required for AeroSpace)"

# Disable Three Finger Drag (enable Mission Control gesture)
echo "  Disabling Three Finger Drag (enabling Mission Control gesture)..."
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadThreeFingerDrag -bool false 2>/dev/null
defaults write com.apple.AppleMultitouchTrackpad TrackpadThreeFingerDrag -bool false 2>/dev/null
echo "  âœ“ Three Finger Swipe Up for Mission Control enabled"

# Disable Transparency (enable Reduce Transparency for better performance)
echo "  Disabling macOS transparency..."
if defaults write com.apple.universalaccess reduceTransparency -bool true 2>/dev/null; then
    echo "  âœ“ Transparency disabled (better performance with SketchyBar)"
else
    echo "  â„¹ï¸  Transparency: Please enable manually in System Settings"
    echo "     System Settings â†’ Accessibility â†’ Display â†’ Reduce transparency (turn ON)"
fi

# Menu bar setting - manual configuration needed in macOS Sequoia 15+
echo "  â„¹ï¸  Menu Bar: Please set manually in System Settings"
echo "     Opening System Settings > Desktop & Dock..."
echo "     Set 'Automatically hide and show the menu bar' to: Always"
open "x-apple.systempreferences:com.apple.preference.dock"
sleep 1

echo ""
echo "âœ… UI components started and configured. Use 'makaron-ui-stop' to disable."


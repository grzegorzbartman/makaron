#!/bin/bash

set -e

export MAKARON_PATH="$HOME/.local/share/makaron"

# Install gum if not available
install_gum_if_needed() {
    if ! command -v gum &> /dev/null; then
        echo "Installing gum..."
        if [ -f "$MAKARON_PATH/install/terminal/gum.sh" ]; then
            bash "$MAKARON_PATH/install/terminal/gum.sh" || true
        else
            if command -v brew &> /dev/null; then
                brew install gum || true
            fi
        fi
    fi
}

# Create backup snapshot
create_backup() {
    if ! command -v zip &> /dev/null; then
        echo "‚ùå zip command is required for backup but not found!"
        echo "Please install zip or run update without backup."
        exit 1
    fi

    local backup_dir="$MAKARON_PATH/tmp"
    mkdir -p "$backup_dir"

    local timestamp=$(date +"%Y-%m-%d-%H-%M-%S")
    local backup_file="$backup_dir/snapshot-backup-$timestamp.zip"

    cd "$MAKARON_PATH"
    zip -r "$backup_file" . -x ".git/*" ".git/**/*" "*.git*" "tmp/*" "tmp/**/*" > /dev/null 2>&1

    if [ $? -ne 0 ]; then
        echo "‚ùå Failed to create backup!"
        exit 1
    fi

    echo "‚úÖ Backup created successfully: $backup_file"

    # Keep only last 5 backups
    local backup_count=$(ls -1 "$backup_dir"/snapshot-backup-*.zip 2>/dev/null | wc -l | tr -d ' ')
    if [ "$backup_count" -gt 5 ]; then
        echo "üßπ Cleaning old backups (keeping last 5)..."
        ls -1t "$backup_dir"/snapshot-backup-*.zip | tail -n +6 | xargs rm -f
    fi

    return 0
}

# Check if makaron exists
if [ ! -d "$MAKARON_PATH" ]; then
    echo "Makaron not found at $MAKARON_PATH"
    echo "Please run the installation script first:"
    echo "curl -sL https://raw.githubusercontent.com/grzegorzbartman/makaron/main/install.sh | bash"
    exit 1
fi

# Install gum if needed
install_gum_if_needed

# Ask for confirmation
echo ""
echo "üîÑ Makaron Update"
echo "================="
echo ""
echo "This will update your Makaron configuration to the latest version."
echo "A backup snapshot will be created first in:"
echo "  $MAKARON_PATH/tmp/snapshot-backup-YYYY-MM-DD-HH-MM-SS.zip"
echo ""
echo "Are you sure you want to continue with the update?"
echo ""

if command -v gum &> /dev/null; then
    if ! gum confirm "Continue with update?"; then
        echo "Update cancelled."
        exit 0
    fi
else
    read -p "Continue with update? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Update cancelled."
        exit 0
    fi
fi

if [ -d "$MAKARON_PATH/.git" ]; then
    cd "$MAKARON_PATH"

    # Check for local changes
    if ! git diff --quiet || ! git diff --cached --quiet; then
        echo ""
        echo "‚ùå Local changes detected in makaron repository!"
        echo ""
        echo "You have uncommitted changes that would be overwritten by the update."
        echo "Please resolve this manually:"
        echo ""
        echo "1. Save your changes:"
        echo "   cd $MAKARON_PATH"
        echo "   git stash push -m 'backup before update'"
        echo ""
        echo "2. Then run update again:"
        echo "   makaron-update"
        echo ""
        echo "3. Restore your changes if needed:"
        echo "   cd $MAKARON_PATH"
        echo "   git stash pop"
        echo ""
        exit 1
    fi

    # Create backup
    echo ""
    echo "üì¶ Creating backup snapshot..."
    create_backup
    echo ""

    echo "Fetching latest changes..."
    git fetch origin main
    git reset --hard origin/main
    echo "Configuration updated successfully!"

    # Run migrations
    if [ -f "$MAKARON_PATH/bin/makaron-migrate" ]; then
        echo "Running migrations..."
        bash "$MAKARON_PATH/bin/makaron-migrate"
    fi

    # Reload configurations
    if [ -f "$MAKARON_PATH/bin/makaron-reload-aerospace-sketchybar" ]; then
        echo "Reloading configurations..."
        bash "$MAKARON_PATH/bin/makaron-reload-aerospace-sketchybar"
    fi

    echo ""
    echo "‚úÖ Update completed successfully!"
else
    echo "Makaron not found at $MAKARON_PATH"
    echo "Please run the installation script first:"
    echo "curl -sL https://raw.githubusercontent.com/grzegorzbartman/makaron/main/install.sh | bash"
    exit 1
fi


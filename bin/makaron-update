#!/bin/bash

set -e

export MAKARON_PATH="$HOME/.local/share/makaron"
SKIP_CONFIRM=false
for arg in "$@"; do
    case "$arg" in
        -y|--yes) SKIP_CONFIRM=true; break ;;
    esac
done

# Install gum if not available
install_gum_if_needed() {
    if ! command -v gum &> /dev/null; then
        echo "Installing gum..."
        if [ -f "$MAKARON_PATH/install/terminal/gum.sh" ]; then
            bash "$MAKARON_PATH/install/terminal/gum.sh" || true
        else
            if command -v brew &> /dev/null; then
                brew install gum || true
            fi
        fi
    fi
}

# Create backup snapshot
create_backup() {
    if ! command -v zip &> /dev/null; then
        echo "âŒ zip command is required for backup but not found!"
        echo "Please install zip or run update without backup."
        exit 1
    fi

    local backup_dir="$MAKARON_PATH/tmp"
    mkdir -p "$backup_dir"

    local timestamp=$(date +"%Y-%m-%d-%H-%M-%S")
    local backup_file="$backup_dir/snapshot-backup-$timestamp.zip"

    cd "$MAKARON_PATH"
    zip -r "$backup_file" . -x ".git/*" ".git/**/*" "*.git*" "tmp/*" "tmp/**/*" > /dev/null 2>&1

    if [ $? -ne 0 ]; then
        echo "âŒ Failed to create backup!"
        exit 1
    fi

    echo "âœ… Backup created successfully: $backup_file"

    # Keep only last 5 backups
    local backup_count=$(ls -1 "$backup_dir"/snapshot-backup-*.zip 2>/dev/null | wc -l | tr -d ' ')
    if [ "$backup_count" -gt 5 ]; then
        echo "ðŸ§¹ Cleaning old backups (keeping last 5)..."
        ls -1t "$backup_dir"/snapshot-backup-*.zip | tail -n +6 | xargs rm -f
    fi

    return 0
}

# Check if makaron exists
if [ ! -d "$MAKARON_PATH" ]; then
    echo "Makaron not found at $MAKARON_PATH"
    echo "Please run the installation script first:"
    echo "curl -sL https://raw.githubusercontent.com/grzegorzbartman/makaron/main/install.sh | bash"
    exit 1
fi

# Install gum if needed
install_gum_if_needed

# Ask for confirmation
echo ""
echo "ðŸ”„ Makaron Update"
echo "================="
echo ""
echo "This will update your Makaron configuration to the latest version."
echo "A backup snapshot will be created first in:"
echo "  $MAKARON_PATH/tmp/snapshot-backup-YYYY-MM-DD-HH-MM-SS.zip"
echo ""
echo "Are you sure you want to continue with the update?"
echo ""

if [ "$SKIP_CONFIRM" = true ]; then
    echo "Proceeding with update (--yes flag)..."
elif command -v gum &> /dev/null && [ -t 0 ]; then
    if ! gum confirm "Continue with update?"; then
        echo "Update cancelled."
        exit 0
    fi
elif [ -t 0 ]; then
    read -p "Continue with update? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Update cancelled."
        exit 0
    fi
else
    echo "No TTY detected. Run with -y or --yes to skip confirmation:"
    echo "  makaron-update -y"
    exit 1
fi

if [ -d "$MAKARON_PATH/.git" ]; then
    cd "$MAKARON_PATH"

    # ~/.local/share/makaron is deployment - always reset to origin, no local commits
    # Create backup
    echo ""
    echo "ðŸ“¦ Creating backup snapshot..."
    create_backup
    echo ""

    echo "Fetching latest changes..."
    git update-index --no-skip-worktree configs/ghostty/config 2>/dev/null || true
    git add configs/ghostty/config 2>/dev/null || true
    git fetch origin main
    git reset --hard origin/main
    git update-index --skip-worktree configs/ghostty/config 2>/dev/null || true
    echo "Configuration updated successfully!"

    # Update user config with new variables
    if [ -f "$MAKARON_PATH/install/makaron-conf.sh" ]; then
        echo "Updating user configuration..."
        source "$MAKARON_PATH/install/makaron-conf.sh"
    fi

    # Run migrations
    if [ -f "$MAKARON_PATH/bin/makaron-migrate" ]; then
        echo "Running migrations..."
        bash "$MAKARON_PATH/bin/makaron-migrate"
    fi

    # Reload configurations based on current UI mode
    if [ -f "$MAKARON_PATH/bin/makaron-ui-helpers" ]; then
        echo "Reloading configurations..."
        source "$MAKARON_PATH/bin/makaron-ui-helpers"
        reload_current_ui
    fi

    echo ""
    echo "âœ… Update completed successfully!"
else
    echo "Makaron not found at $MAKARON_PATH"
    echo "Please run the installation script first:"
    echo "curl -sL https://raw.githubusercontent.com/grzegorzbartman/makaron/main/install.sh | bash"
    exit 1
fi


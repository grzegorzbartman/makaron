#!/bin/bash

# Helper script to switch themes
# Usage: makaron-switch-theme <theme-name>

set -e

THEME_NAME="$1"

if [ -z "$THEME_NAME" ]; then
    echo "Error: Theme name required"
    echo "Usage: makaron-switch-theme <theme-name>"
    exit 1
fi

MAKARON_PATH="${MAKARON_PATH:-$HOME/.local/share/makaron}"
THEME_DIR="$MAKARON_PATH/themes/$THEME_NAME"
CURRENT_THEME_LINK="$MAKARON_PATH/current-theme"
GHOSTTY_CONFIG="$MAKARON_PATH/configs/ghostty/config"

# Check if theme exists
if [ ! -d "$THEME_DIR" ]; then
    echo "Error: Theme '$THEME_NAME' not found in $MAKARON_PATH/themes/"
    exit 1
fi

echo "Switching to theme: $THEME_NAME"

# ============================================================
# THEME MAPPING: Makaron themes -> Ghostty themes
# ============================================================
# This maps makaron theme names to their corresponding Ghostty theme names
# Format: returns "Dark Theme Name|Light Theme Name" for each theme
# ============================================================

get_ghostty_theme_mapping() {
    local theme="$1"

    case "$theme" in
        tokyo-night)
            echo "TokyoNight Storm|TokyoNight Day"
            ;;
        catppuccin|catppuccin-mocha-dark)
            echo "Catppuccin Mocha|Catppuccin Latte"
            ;;
        catppuccin-latte)
            echo "Catppuccin Latte|Catppuccin Latte"
            ;;
        gruvbox)
            echo "Gruvbox Dark|Gruvbox Light"
            ;;
        nord)
            echo "Nord|Nord Light"
            ;;
        everforest)
            echo "Everforest Dark Hard|Everforest Light Med"
            ;;
        kanagawa)
            echo "Kanagawa Dragon|Kanagawa Dragon"
            ;;
        flexoki-light)
            echo "Flexoki Light|Flexoki Light"
            ;;
        rose-pine)
            echo "Rosé Pine|Rosé Pine Dawn"
            ;;
        matte-black|droptica-dark|hackerman)
            echo "TokyoNight Storm|TokyoNight Day"
            ;;
        osaka-jade|verdant-dark|verdant-light)
            echo "Everforest Dark Hard|Everforest Light Med"
            ;;
        ristretto)
            echo "Gruvbox Dark|Gruvbox Light"
            ;;
        ethereal)
            echo "Catppuccin Mocha|Catppuccin Latte"
            ;;
        underwater-dark)
            echo "Nord|Nord Light"
            ;;
        underwater-light)
            echo "Nord Light|Nord Light"
            ;;
        *)
            # Fallback for unknown themes
            echo "TokyoNight Storm|TokyoNight Day"
            ;;
    esac
}

# Function to get Ghostty theme name (full name with variant)
# Returns the complete theme name as it appears in Ghostty
get_ghostty_theme() {
    local theme="$1"
    local mode="$2"

    local themes=$(get_ghostty_theme_mapping "$theme")
    local dark_theme="${themes%|*}"
    local light_theme="${themes#*|}"

    if [ "$mode" = "dark" ]; then
        echo "$dark_theme"
    else
        echo "$light_theme"
    fi
}

# Update current-theme symlink
rm -f "$CURRENT_THEME_LINK"
ln -s "$THEME_DIR" "$CURRENT_THEME_LINK"

# Set macOS appearance mode based on theme
MODE="dark"  # default
if [ -f "$THEME_DIR/mode" ]; then
    MODE=$(cat "$THEME_DIR/mode")
    if [ "$MODE" = "dark" ]; then
        echo "Setting macOS appearance to Dark Mode..."
        osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to true' 2>/dev/null || true
    elif [ "$MODE" = "light" ]; then
        echo "Setting macOS appearance to Light Mode..."
        osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to false' 2>/dev/null || true
    fi
fi

# Function to update GHOSTTY_THEME environment variable in shell config
update_ghostty_theme_env() {
    local config_file="$1"
    local theme_value="$2"
    local export_line="export GHOSTTY_THEME=\"$theme_value\""

    # Remove old GHOSTTY_THEME entries if they exist
    if [ -f "$config_file" ] && grep -q "^export GHOSTTY_THEME=" "$config_file" 2>/dev/null; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' '/^export GHOSTTY_THEME=/d' "$config_file"
        else
            sed -i '/^export GHOSTTY_THEME=/d' "$config_file"
        fi
    fi

    # Add new entry
    echo "$export_line" >> "$config_file"
}

# Function to update Ghostty config file based on GHOSTTY_THEME variable
update_ghostty_config_from_env() {
    local theme_value="$1"

    if [ -f "$GHOSTTY_CONFIG" ]; then
        local theme_string="theme = $theme_value"

        # Check if theme line exists (with flexible spacing: theme=, theme =, theme  =, etc.)
        if grep -qE "^[[:space:]]*theme[[:space:]]*=" "$GHOSTTY_CONFIG"; then
            # Replace existing theme line (handles any spacing format)
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' "s|^[[:space:]]*theme[[:space:]]*=.*|$theme_string|" "$GHOSTTY_CONFIG"
            else
                sed -i "s|^[[:space:]]*theme[[:space:]]*=.*|$theme_string|" "$GHOSTTY_CONFIG"
            fi
        else
            # Add theme line if it doesn't exist
            echo "" >> "$GHOSTTY_CONFIG"
            echo "$theme_string" >> "$GHOSTTY_CONFIG"
        fi
    fi
}

# Update Ghostty theme configuration using environment variable
DARK_THEME=$(get_ghostty_theme "$THEME_NAME" "dark")
LIGHT_THEME=$(get_ghostty_theme "$THEME_NAME" "light")

# Build theme string: dark:ThemeName, light:ThemeName
GHOSTTY_THEME_VALUE="dark:$DARK_THEME, light:$LIGHT_THEME"

# Update environment variable in shell config files
ensure_shell_configs() {
    touch "$HOME/.zshrc" 2>/dev/null || true
    touch "$HOME/.bashrc" 2>/dev/null || true
}

ensure_shell_configs
update_ghostty_theme_env "$HOME/.zshrc" "$GHOSTTY_THEME_VALUE"
update_ghostty_theme_env "$HOME/.bashrc" "$GHOSTTY_THEME_VALUE"

# Export for current session
export GHOSTTY_THEME="$GHOSTTY_THEME_VALUE"

# Update Ghostty config file based on environment variable
update_ghostty_config_from_env "$GHOSTTY_THEME_VALUE"
echo "Updated Ghostty theme configuration (using GHOSTTY_THEME environment variable)"

# Reload Ghostty configuration using SIGUSR2 signal
GHOSTTY_PID=$(pgrep -f "ghostty" | head -n 1)
if [ -n "$GHOSTTY_PID" ]; then
    if kill -SIGUSR2 "$GHOSTTY_PID" 2>/dev/null; then
        echo "Reloaded Ghostty configuration (PID: $GHOSTTY_PID)"
    else
        echo "Note: Could not send reload signal. Press Cmd+Shift+, in Ghostty to reload config"
    fi
else
    echo "Note: Ghostty not running. Config will be loaded on next start"
fi

# Set wallpaper if backgrounds directory exists
if [ -d "$THEME_DIR/backgrounds" ]; then
    # Use the first image file found in backgrounds/
    WALLPAPER=$(find "$THEME_DIR/backgrounds" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) | sort | head -n 1)
    if [ -n "$WALLPAPER" ]; then
        echo "Setting wallpaper..."
        osascript -e "tell application \"Finder\" to set desktop picture to POSIX file \"$WALLPAPER\""
    fi
fi

# Reload configurations
echo "Reloading UI configurations..."
"$MAKARON_PATH/bin/makaron-reload-aerospace-sketchybar"

echo "✨ Theme switched to $THEME_NAME successfully!"


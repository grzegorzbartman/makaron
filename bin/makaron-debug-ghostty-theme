#!/bin/bash

# Diagnostic script to check why Ghostty theme is not being updated
# Run this on the problematic computer

echo "=== Makaron Ghostty Theme Diagnostic ==="
echo ""

# Check MAKARON_PATH
MAKARON_PATH="${MAKARON_PATH:-$HOME/.local/share/makaron}"
echo "1. MAKARON_PATH: $MAKARON_PATH"
if [ ! -d "$MAKARON_PATH" ]; then
    echo "   ❌ ERROR: MAKARON_PATH directory does not exist!"
else
    echo "   ✓ MAKARON_PATH exists"
fi
echo ""

# Check Ghostty config path
GHOSTTY_CONFIG="$MAKARON_PATH/configs/ghostty/config"
echo "2. Ghostty config path: $GHOSTTY_CONFIG"
if [ -f "$GHOSTTY_CONFIG" ]; then
    echo "   ✓ Config file exists"
    echo "   Permissions: $(ls -l "$GHOSTTY_CONFIG" | awk '{print $1, $3, $4}')"
    if [ -w "$GHOSTTY_CONFIG" ]; then
        echo "   ✓ File is writable"
    else
        echo "   ❌ ERROR: File is NOT writable!"
    fi
else
    echo "   ❌ ERROR: Config file does not exist!"
fi
echo ""

# Check symlink
SYMLINK_PATH="$HOME/.config/ghostty"
echo "3. Symlink check: $SYMLINK_PATH"
if [ -L "$SYMLINK_PATH" ]; then
    TARGET=$(readlink "$SYMLINK_PATH")
    echo "   ✓ Symlink exists"
    echo "   Target: $TARGET"
    if [ "$TARGET" = "$MAKARON_PATH/configs/ghostty" ]; then
        echo "   ✓ Symlink points to correct location"
    else
        echo "   ⚠️  WARNING: Symlink points to different location!"
        echo "      Expected: $MAKARON_PATH/configs/ghostty"
    fi
    if [ -e "$SYMLINK_PATH" ]; then
        echo "   ✓ Symlink target is accessible"
    else
        echo "   ❌ ERROR: Symlink target is broken!"
    fi
elif [ -d "$SYMLINK_PATH" ]; then
    echo "   ❌ ERROR: $SYMLINK_PATH is a directory, not a symlink!"
elif [ -f "$SYMLINK_PATH" ]; then
    echo "   ❌ ERROR: $SYMLINK_PATH is a file, not a symlink!"
else
    echo "   ❌ ERROR: Symlink does not exist!"
fi
echo ""

# Check theme line in config
if [ -f "$GHOSTTY_CONFIG" ]; then
    echo "4. Theme line in config:"
    if grep -q "^theme = " "$GHOSTTY_CONFIG"; then
        THEME_LINE=$(grep "^theme = " "$GHOSTTY_CONFIG")
        echo "   ✓ Found theme line:"
        echo "     $THEME_LINE"
    else
        echo "   ❌ ERROR: No 'theme = ' line found in config!"
        echo "   First few lines of config:"
        head -n 10 "$GHOSTTY_CONFIG" | sed 's/^/     /'
    fi
    echo ""

    # Check for variations
    echo "5. Checking for theme line variations:"
    if grep -q "^theme=" "$GHOSTTY_CONFIG"; then
        echo "   ⚠️  Found 'theme=' (no spaces) - this might be the issue!"
    fi
    if grep -q "^[[:space:]]*theme[[:space:]]*=" "$GHOSTTY_CONFIG"; then
        echo "   ⚠️  Found theme line with different spacing"
    fi
    echo ""
fi

# Check sed command
echo "6. Testing sed command:"
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "   OS: macOS (BSD sed)"
    SED_TEST=$(echo "test line" | sed 's/test/TEST/' 2>&1)
    if [ "$SED_TEST" = "TEST line" ]; then
        echo "   ✓ sed works correctly"
    else
        echo "   ❌ ERROR: sed test failed: $SED_TEST"
    fi
else
    echo "   OS: Linux (GNU sed)"
    SED_TEST=$(echo "test line" | sed 's/test/TEST/' 2>&1)
    if [ "$SED_TEST" = "TEST line" ]; then
        echo "   ✓ sed works correctly"
    else
        echo "   ❌ ERROR: sed test failed: $SED_TEST"
    fi
fi
echo ""

# Test actual sed replacement
if [ -f "$GHOSTTY_CONFIG" ] && [ -w "$GHOSTTY_CONFIG" ]; then
    echo "7. Testing sed replacement (dry run):"
    TEST_STRING="theme = dark:TestTheme, light:TestTheme"
    if grep -q "^theme = " "$GHOSTTY_CONFIG"; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            SED_OUTPUT=$(sed "s|^theme = .*|$TEST_STRING|" "$GHOSTTY_CONFIG" | grep "^theme = " || echo "NOT_FOUND")
        else
            SED_OUTPUT=$(sed "s|^theme = .*|$TEST_STRING|" "$GHOSTTY_CONFIG" | grep "^theme = " || echo "NOT_FOUND")
        fi
        if [ "$SED_OUTPUT" = "$TEST_STRING" ]; then
            echo "   ✓ sed replacement would work"
        else
            echo "   ❌ ERROR: sed replacement test failed!"
            echo "      Output: $SED_OUTPUT"
        fi
    fi
    echo ""
fi

# Check if script is executable
SCRIPT_PATH="$MAKARON_PATH/bin/makaron-switch-theme"
echo "8. Script check:"
if [ -f "$SCRIPT_PATH" ]; then
    echo "   ✓ Script exists"
    if [ -x "$SCRIPT_PATH" ]; then
        echo "   ✓ Script is executable"
    else
        echo "   ❌ ERROR: Script is NOT executable!"
        echo "   Fix: chmod +x $SCRIPT_PATH"
    fi
else
    echo "   ❌ ERROR: Script does not exist!"
fi
echo ""

echo "=== Diagnostic Complete ==="
echo ""
echo "If you see errors above, fix them and try again."
echo "If theme line format is wrong, you may need to fix the config file manually."


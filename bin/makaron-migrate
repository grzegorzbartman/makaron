#!/bin/bash

# Makaron Migration System
# Based on omarchy migration system
# Runs pending migrations in chronological order

# Ensure MAKARON_PATH is set
if [ -z "$MAKARON_PATH" ]; then
    export MAKARON_PATH="$HOME/.local/share/makaron"
fi

# Where we store an empty file for each migration that has already been performed.
STATE_DIR="$HOME/.local/state/makaron/migrations"
mkdir -p "$STATE_DIR"

# Skipped migrations are tracked separately
mkdir -p "$STATE_DIR/skipped"

# Run any pending migrations
for file in ~/.local/share/makaron/migrations/*.sh; do
  # Skip if no migration files exist
  if [[ ! -f "$file" ]]; then
    continue
  fi

  filename=$(basename "$file")

  if [[ ! -f "$STATE_DIR/$filename" && ! -f "$STATE_DIR/skipped/$filename" ]]; then
    echo -e "\e[32m\nRunning migration (${filename%.sh})\e[0m"

    if bash $file; then
      touch "$STATE_DIR/$filename"
      echo -e "\e[32mMigration ${filename%.sh} completed successfully\e[0m"
    else
      echo -e "\e[31mMigration ${filename%.sh} failed\e[0m"
      if command -v gum &> /dev/null; then
        if gum confirm "Migration ${filename%.sh} failed. Skip and continue?"; then
          touch "$STATE_DIR/skipped/$filename"
        else
          exit 1
        fi
      else
        read -p "Migration ${filename%.sh} failed. Skip and continue? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
          touch "$STATE_DIR/skipped/$filename"
        else
          exit 1
        fi
      fi
    fi
  fi
done

echo -e "\e[32mAll migrations completed\e[0m"

#!/bin/bash

# Universal diagnostic script for Makaron system
# Checks configuration, status, and settings across all components

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          Makaron System Diagnostic Tool                     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Set MAKARON_PATH
MAKARON_PATH="${MAKARON_PATH:-$HOME/.local/share/makaron}"

# ============================================================================
# SECTION: System Information
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š SYSTEM INFORMATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  macOS Version: $(sw_vers -productVersion)"
echo "  MAKARON_PATH: $MAKARON_PATH"
if [ ! -d "$MAKARON_PATH" ]; then
    echo "  âŒ ERROR: MAKARON_PATH directory does not exist!"
else
    echo "  âœ“ MAKARON_PATH exists"
fi
echo ""

# ============================================================================
# SECTION: macOS Settings
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ MACOS SETTINGS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Keyboard Settings
echo "âŒ¨ï¸  KEYBOARD SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
INITIAL_KEY_REPEAT=$(defaults read -g InitialKeyRepeat 2>/dev/null || echo "not set")
echo "  Initial Key Repeat (delay before repeat starts):"
echo "    Value: $INITIAL_KEY_REPEAT (25 = slower, 15 = normal)"
echo "    Expected: 25"
echo ""

KEY_REPEAT=$(defaults read -g KeyRepeat 2>/dev/null || echo "not set")
echo "  Key Repeat (repeat rate):"
echo "    Value: $KEY_REPEAT (3 = slower, 2 = normal)"
echo "    Expected: 3"
echo ""

# Finder Settings
echo "ğŸ” FINDER SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
SHOW_ALL_FILES=$(defaults read com.apple.finder AppleShowAllFiles 2>/dev/null || echo "not set")
echo "  Show All Files (including hidden files):"
echo "    Value: $SHOW_ALL_FILES"
echo "    Expected: YES"
echo ""

SHOW_ALL_EXTENSIONS=$(defaults read NSGlobalDomain AppleShowAllExtensions 2>/dev/null || echo "not set")
echo "  Show All File Extensions:"
echo "    Value: $SHOW_ALL_EXTENSIONS"
echo "    Expected: 1"
echo ""

VIEW_STYLE=$(defaults read com.apple.finder FXPreferredViewStyle 2>/dev/null || echo "not set")
echo "  Default View Style:"
echo "    Value: $VIEW_STYLE (Nlsv = list view)"
echo "    Expected: Nlsv"
echo ""

SHOW_PATHBAR=$(defaults read com.apple.finder ShowPathbar 2>/dev/null || echo "not set")
echo "  Show Path Bar:"
echo "    Value: $SHOW_PATHBAR"
echo "    Expected: 1"
echo ""

SHOW_STATUSBAR=$(defaults read com.apple.finder ShowStatusBar 2>/dev/null || echo "not set")
echo "  Show Status Bar:"
echo "    Value: $SHOW_STATUSBAR"
echo "    Expected: 1"
echo ""

FOLDERS_FIRST=$(defaults read com.apple.finder _FXSortFoldersFirst 2>/dev/null || echo "not set")
echo "  Sort Folders First:"
echo "    Value: $FOLDERS_FIRST"
echo "    Expected: 1"
echo ""

NEW_WINDOW_TARGET=$(defaults read com.apple.finder NewWindowTarget 2>/dev/null || echo "not set")
echo "  New Window Opens To:"
echo "    Value: $NEW_WINDOW_TARGET (PfHm = Home folder)"
echo "    Expected: PfHm"
echo ""

SEARCH_SCOPE=$(defaults read com.apple.finder FXDefaultSearchScope 2>/dev/null || echo "not set")
echo "  Default Search Scope:"
echo "    Value: $SEARCH_SCOPE (SCcf = current folder)"
echo "    Expected: SCcf"
echo ""

# System & Trackpad Settings
echo "ğŸ–±ï¸  SYSTEM & TRACKPAD SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
QUARANTINE=$(defaults read com.apple.LaunchServices LSQuarantine 2>/dev/null || echo "not set")
echo "  Disable Quarantine Warning (open apps from unidentified developers):"
echo "    Value: $QUARANTINE"
echo "    Expected: 0"
echo ""

TRACKPAD_CLICK=$(defaults read com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking 2>/dev/null || echo "not set")
echo "  Trackpad Tap to Click:"
echo "    Value: $TRACKPAD_CLICK"
echo "    Expected: 1"
echo ""

THREE_FINGER_DRAG=$(defaults read com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadThreeFingerDrag 2>/dev/null || echo "not set")
echo "  Three Finger Drag:"
if [ "$THREE_FINGER_DRAG" = "1" ]; then
    echo "    Status: âœ“ Enabled (drag windows with 3 fingers)"
    echo "    Value: $THREE_FINGER_DRAG"
    echo "    Note: Conflicts with 3-finger Mission Control gesture"
else
    echo "    Status: â—‹ Disabled (3-finger Mission Control enabled)"
    echo "    Value: $THREE_FINGER_DRAG"
    echo "    Note: Use 3 fingers swipe up for Mission Control"
fi
echo ""

# Text & Input Settings
echo "ğŸ“ TEXT & INPUT SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
AUTO_SPELLING=$(defaults read NSGlobalDomain NSAutomaticSpellingCorrectionEnabled 2>/dev/null || echo "not set")
echo "  Automatic Spelling Correction:"
echo "    Value: $AUTO_SPELLING"
echo "    Expected: 0 (disabled)"
echo ""

AUTO_CAPITALIZE=$(defaults read NSGlobalDomain NSAutomaticCapitalizationEnabled 2>/dev/null || echo "not set")
echo "  Automatic Capitalization:"
echo "    Value: $AUTO_CAPITALIZE"
echo "    Expected: 0 (disabled)"
echo ""

AUTO_DASH=$(defaults read NSGlobalDomain NSAutomaticDashSubstitutionEnabled 2>/dev/null || echo "not set")
echo "  Automatic Dash Substitution:"
echo "    Value: $AUTO_DASH"
echo "    Expected: 0 (disabled)"
echo ""

AUTO_QUOTE=$(defaults read NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled 2>/dev/null || echo "not set")
echo "  Automatic Quote Substitution:"
echo "    Value: $AUTO_QUOTE"
echo "    Expected: 0 (disabled)"
echo ""

PRESS_AND_HOLD=$(defaults read NSGlobalDomain ApplePressAndHoldEnabled 2>/dev/null || echo "not set")
echo "  Press and Hold for Special Characters:"
echo "    Value: $PRESS_AND_HOLD"
echo "    Expected: 0 (disabled, allows key repeat)"
echo ""

# Dialog Settings
echo "ğŸ’¾ DIALOG SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
SAVE_EXPANDED=$(defaults read NSGlobalDomain NSNavPanelExpandedStateForSaveMode 2>/dev/null || echo "not set")
echo "  Expanded Save Dialogs:"
echo "    Value: $SAVE_EXPANDED"
echo "    Expected: 1"
echo ""

PRINT_EXPANDED=$(defaults read NSGlobalDomain PMPrintingExpandedStateForPrint 2>/dev/null || echo "not set")
echo "  Expanded Print Dialogs:"
echo "    Value: $PRINT_EXPANDED"
echo "    Expected: 1"
echo ""

# Performance Settings
echo "âš¡ PERFORMANCE SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
WINDOW_RESIZE=$(defaults read NSGlobalDomain NSWindowResizeTime 2>/dev/null || echo "not set")
echo "  Window Resize Animation Speed:"
echo "    Value: $WINDOW_RESIZE"
echo "    Expected: 0.001 (very fast)"
echo ""

TOOLBAR_ROLLOVER=$(defaults read NSGlobalDomain NSToolbarTitleViewRolloverDelay 2>/dev/null || echo "not set")
echo "  Toolbar Title Rollover Delay:"
echo "    Value: $TOOLBAR_ROLLOVER"
echo "    Expected: 0 (instant)"
echo ""

# Screenshot Settings
echo "ğŸ“¸ SCREENSHOT SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
SCREENSHOT_TYPE=$(defaults read com.apple.screencapture type 2>/dev/null || echo "not set")
echo "  Screenshot Format:"
echo "    Value: $SCREENSHOT_TYPE"
echo "    Expected: png"
echo ""

SCREENSHOT_LOCATION=$(defaults read com.apple.screencapture location 2>/dev/null || echo "not set")
echo "  Screenshot Location:"
echo "    Value: $SCREENSHOT_LOCATION"
echo "    Expected: $HOME/Desktop/Screenshots"
echo ""

SCREENSHOT_SHADOW=$(defaults read com.apple.screencapture disable-shadow 2>/dev/null || echo "not set")
echo "  Disable Screenshot Shadow:"
echo "    Value: $SCREENSHOT_SHADOW"
echo "    Expected: 1"
echo ""

# .DS_Store Settings
echo "ğŸ“ .DS_STORE SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
DS_NETWORK=$(defaults read com.apple.desktopservices DSDontWriteNetworkStores 2>/dev/null || echo "not set")
echo "  Don't Write .DS_Store on Network Volumes:"
echo "    Value: $DS_NETWORK"
echo "    Expected: 1"
echo ""

DS_USB=$(defaults read com.apple.desktopservices DSDontWriteUSBStores 2>/dev/null || echo "not set")
echo "  Don't Write .DS_Store on USB Volumes:"
echo "    Value: $DS_USB"
echo "    Expected: 1"
echo ""

# Library Folder
echo "ğŸ“š LIBRARY FOLDER"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -d "$HOME/Library" ]; then
    LIBRARY_HIDDEN=$(ls -ldO "$HOME/Library" | grep -q "hidden" && echo "hidden" || echo "visible")
    echo "  Library Folder Visibility:"
    echo "    Value: $LIBRARY_HIDDEN"
    echo "    Expected: visible"
else
    echo "  Library folder not found"
fi
echo ""

# Dock Settings
echo "ğŸ¯ DOCK SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
DOCK_AUTOHIDE=$(defaults read com.apple.dock autohide 2>/dev/null || echo "not set")
echo "  Dock Autohide:"
echo "    Value: $DOCK_AUTOHIDE"
echo "    Expected: 1"
echo ""

DOCK_AUTOHIDE_DELAY=$(defaults read com.apple.Dock autohide-delay 2>/dev/null || echo "not set")
echo "  Dock Autohide Delay:"
echo "    Value: $DOCK_AUTOHIDE_DELAY"
echo "    Expected: 0 (instant)"
echo ""

DOCK_AUTOHIDE_TIME=$(defaults read com.apple.dock autohide-time-modifier 2>/dev/null || echo "not set")
echo "  Dock Autohide Animation Time:"
echo "    Value: $DOCK_AUTOHIDE_TIME"
echo "    Expected: 0 (instant)"
echo ""

EXPOSE_ANIMATION=$(defaults read com.apple.dock expose-animation-duration 2>/dev/null || echo "not set")
echo "  Mission Control Animation Duration:"
echo "    Value: $EXPOSE_ANIMATION"
echo "    Expected: 0.1"
echo ""

MRU_SPACES=$(defaults read com.apple.dock mru-spaces 2>/dev/null || echo "not set")
echo "  Automatically Rearrange Spaces:"
echo "    Value: $MRU_SPACES"
echo "    Expected: 0 (disabled)"
echo ""

EXPOSE_GROUP_APPS=$(defaults read com.apple.dock expose-group-apps 2>/dev/null || echo "not set")
echo "  Mission Control Group Windows by App:"
echo "    Value: $EXPOSE_GROUP_APPS"
echo "    Expected: 1 (fixes AeroSpace window visibility)"
echo ""

# Dock & Menu Bar Settings
echo "ğŸ“‹ DOCK & MENU BAR SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
DOCK_AUTOHIDE_STATUS=$(defaults read com.apple.dock autohide 2>/dev/null || echo "not set")
echo "  Dock Autohide:"
if [ "$DOCK_AUTOHIDE_STATUS" = "1" ]; then
    echo "    Status: âœ“ Enabled (Dock is hidden)"
    echo "    Value: $DOCK_AUTOHIDE_STATUS"
else
    echo "    Status: â—‹ Disabled (Dock is visible)"
    echo "    Value: $DOCK_AUTOHIDE_STATUS"
fi
echo ""

MENUBAR_AUTOHIDE=$(defaults read NSGlobalDomain _HIHideMenuBar 2>/dev/null || echo "not set")
echo "  Menu Bar Autohide:"
if [ "$MENUBAR_AUTOHIDE" = "1" ]; then
    echo "    Status: âœ“ Enabled (menu bar is hidden)"
    echo "    Value: $MENUBAR_AUTOHIDE"
    echo "    Note: In macOS Sequoia 15+, use System Settings to change"
else
    echo "    Status: â—‹ Disabled (menu bar is visible)"
    echo "    Value: $MENUBAR_AUTOHIDE"
    echo "    Note: In macOS Sequoia 15+, use System Settings to change"
fi
echo ""

# Accessibility Settings
echo "â™¿ ACCESSIBILITY SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
REDUCE_TRANSPARENCY=$(defaults read com.apple.universalaccess reduceTransparency 2>/dev/null || echo "not set")
echo "  Reduce Transparency:"
if [ "$REDUCE_TRANSPARENCY" = "1" ]; then
    echo "    Status: âœ“ Enabled (transparency disabled - better performance)"
    echo "    Value: $REDUCE_TRANSPARENCY"
else
    echo "    Status: â—‹ Disabled (transparency enabled - visual effects)"
    echo "    Value: $REDUCE_TRANSPARENCY"
fi
echo ""

# iCloud Settings
echo "â˜ï¸  ICLOUD SETTINGS"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ICLOUD_SAVE=$(defaults read NSGlobalDomain NSDocumentSaveNewDocumentsToCloud 2>/dev/null || echo "not set")
echo "  Save New Documents to iCloud by Default:"
echo "    Value: $ICLOUD_SAVE"
echo "    Expected: 0 (save to local disk)"
echo ""

# Apple Intelligence
echo "ğŸ¤– APPLE INTELLIGENCE"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
APPLE_INTELLIGENCE=$(defaults read com.apple.CloudSubscriptionFeatures.optIn "545129924" 2>/dev/null || echo "not set")
echo "  Apple Intelligence:"
echo "    Value: $APPLE_INTELLIGENCE"
echo "    Expected: 0 (disabled)"
echo ""

# Wallpaper
echo "ğŸ–¼ï¸  WALLPAPER"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
WALLPAPER_PATH="$MAKARON_PATH/assets/1-scenery-pink-lakeside-sunset-lake-landscape-scenic-panorama-7680x3215-144.png"
if [ -f "$WALLPAPER_PATH" ]; then
    echo "  Default Wallpaper File:"
    echo "    âœ“ Exists at $WALLPAPER_PATH"
else
    echo "  Default Wallpaper File:"
    echo "    âŒ Not found at $WALLPAPER_PATH"
fi
echo ""

# ============================================================================
# SECTION: AeroSpace
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ AEROSPACE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v aerospace &> /dev/null; then
    echo "  âœ“ AeroSpace installed"

    # Check if running
    if pgrep -f "AeroSpace" > /dev/null; then
        echo "  âœ“ AeroSpace is running"

        # Check enable status
        AEROSPACE_ENABLED=$(aerospace list-workspaces --monitor all 2>/dev/null && echo "enabled" || echo "disabled")
        if [ "$AEROSPACE_ENABLED" = "enabled" ]; then
            echo "  âœ“ AeroSpace window management: ENABLED"
        else
            echo "  â—‹ AeroSpace window management: DISABLED"
        fi

        # List windows
        echo ""
        echo "  Current Windows:"
        aerospace list-windows --all 2>/dev/null | while read -r line; do
            echo "    â€¢ $line"
        done || echo "    (Could not retrieve window list)"

        # List workspaces
        echo ""
        echo "  Current Workspaces:"
        aerospace list-workspaces --monitor all 2>/dev/null | while read -r workspace; do
            FOCUSED=$(aerospace list-workspaces --monitor focused 2>/dev/null | grep "^${workspace}$" && echo "â† focused" || echo "")
            echo "    â€¢ $workspace $FOCUSED"
        done || echo "    (Could not retrieve workspace list)"
    else
        echo "  âš ï¸  AeroSpace is NOT running"
    fi

    # Check config
    if [ -L "$HOME/.aerospace.toml" ]; then
        TARGET=$(readlink "$HOME/.aerospace.toml")
        echo ""
        echo "  Config symlink: âœ“"
        echo "    Target: $TARGET"
        if [ "$TARGET" = "$MAKARON_PATH/configs/aerospace/.aerospace.toml" ]; then
            echo "    âœ“ Points to correct location"
        else
            echo "    âš ï¸  Points to different location"
        fi
    else
        echo ""
        echo "  Config symlink: âŒ Not found or not a symlink"
    fi
else
    echo "  âŒ AeroSpace is NOT installed"
fi
echo ""

# ============================================================================
# SECTION: SketchyBar
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š SKETCHYBAR"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v sketchybar &> /dev/null; then
    echo "  âœ“ SketchyBar installed"

    # Check if running
    if pgrep -f "sketchybar" > /dev/null; then
        echo "  âœ“ SketchyBar is running"
    else
        echo "  âš ï¸  SketchyBar is NOT running"
    fi

    # Check brew service
    if brew services list | grep -q "sketchybar.*started"; then
        echo "  âœ“ Brew service: started"
    else
        echo "  â—‹ Brew service: stopped"
    fi

    # Check config
    if [ -L "$HOME/.config/sketchybar" ]; then
        TARGET=$(readlink "$HOME/.config/sketchybar")
        echo "  Config symlink: âœ“"
        echo "    Target: $TARGET"
        if [ "$TARGET" = "$MAKARON_PATH/configs/sketchybar" ]; then
            echo "    âœ“ Points to correct location"
        else
            echo "    âš ï¸  Points to different location"
        fi
    else
        echo "  Config symlink: âŒ Not found or not a symlink"
    fi
else
    echo "  âŒ SketchyBar is NOT installed"
fi
echo ""

# ============================================================================
# SECTION: Borders
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”² BORDERS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v borders &> /dev/null; then
    echo "  âœ“ Borders installed"

    # Check if running
    if pgrep -f "borders" > /dev/null; then
        echo "  âœ“ Borders is running"
    else
        echo "  âš ï¸  Borders is NOT running"
    fi

    # Check brew service
    if brew services list | grep -q "borders.*started"; then
        echo "  âœ“ Brew service: started"
    else
        echo "  â—‹ Brew service: stopped"
    fi
else
    echo "  âŒ Borders is NOT installed"
fi
echo ""

# ============================================================================
# SECTION: Ghostty Terminal
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‘» GHOSTTY TERMINAL"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

GHOSTTY_CONFIG="$MAKARON_PATH/configs/ghostty/config"

if [ -f "$GHOSTTY_CONFIG" ]; then
    echo "  âœ“ Config file exists"
    echo "    Path: $GHOSTTY_CONFIG"

    if [ -w "$GHOSTTY_CONFIG" ]; then
        echo "    âœ“ File is writable"
    else
        echo "    âŒ File is NOT writable!"
    fi

    # Check theme line
    if grep -q "^theme = " "$GHOSTTY_CONFIG"; then
        THEME_LINE=$(grep "^theme = " "$GHOSTTY_CONFIG")
        echo "    Current theme: $THEME_LINE"
    else
        echo "    âš ï¸  No theme line found in config"
    fi
else
    echo "  âŒ Config file does not exist!"
fi

# Check symlink
SYMLINK_PATH="$HOME/.config/ghostty"
if [ -L "$SYMLINK_PATH" ]; then
    TARGET=$(readlink "$SYMLINK_PATH")
    echo "  Config symlink: âœ“"
    echo "    Target: $TARGET"
    if [ "$TARGET" = "$MAKARON_PATH/configs/ghostty" ]; then
        echo "    âœ“ Points to correct location"
    else
        echo "    âš ï¸  Points to different location"
    fi
else
    echo "  Config symlink: âŒ Not found or not a symlink"
fi

# Check GHOSTTY_THEME env var
if [ -n "$GHOSTTY_THEME" ]; then
    echo "  GHOSTTY_THEME env: $GHOSTTY_THEME"
else
    echo "  GHOSTTY_THEME env: (not set)"
fi

# Check actual config file content
echo ""
echo "  Ghostty Config File Content:"
echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ -f "$HOME/.config/ghostty/config" ]; then
    echo "  Location: $HOME/.config/ghostty/config"
    if grep -q "^theme = " "$HOME/.config/ghostty/config"; then
        THEME_VALUE=$(grep "^theme = " "$HOME/.config/ghostty/config" | head -1)
        echo "  Theme line: $THEME_VALUE"
        
        # Check for "One Dark" references
        if echo "$THEME_VALUE" | grep -qi "One Dark"; then
            echo "  âŒ ERROR: Config contains 'One Dark' theme (does not exist in Ghostty!)"
        else
            echo "  âœ“ No 'One Dark' references found"
        fi
    else
        echo "  âš ï¸  No theme line found"
    fi
else
    echo "  âŒ Config file not found at $HOME/.config/ghostty/config"
fi

# Check shell config files for GHOSTTY_THEME
echo ""
echo "  Shell Config Files:"
echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
for config_file in "$HOME/.zshrc" "$HOME/.bashrc"; do
    if [ -f "$config_file" ]; then
        echo "  $(basename $config_file):"
        if grep -q "GHOSTTY_THEME" "$config_file"; then
            GHOSTTY_LINE=$(grep "GHOSTTY_THEME" "$config_file" | tail -1)
            echo "    Found: $GHOSTTY_LINE"
            if echo "$GHOSTTY_LINE" | grep -qi "One Dark"; then
                echo "    âŒ ERROR: Contains 'One Dark' theme reference!"
            else
                echo "    âœ“ No 'One Dark' references"
            fi
        else
            echo "    No GHOSTTY_THEME variable found"
        fi
    fi
done

# Check migration status
echo ""
echo "  Migration Status (1764134080 - Fix One Dark):"
echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
MIGRATION_STATE_DIR="$HOME/.local/state/makaron/migrations"
if [ -f "$MIGRATION_STATE_DIR/1764134080.sh" ]; then
    echo "  âœ“ Migration completed"
    echo "    Completed at: $(stat -f "%Sm" "$MIGRATION_STATE_DIR/1764134080.sh" 2>/dev/null || stat -c "%y" "$MIGRATION_STATE_DIR/1764134080.sh" 2>/dev/null)"
elif [ -f "$MIGRATION_STATE_DIR/skipped/1764134080.sh" ]; then
    echo "  âš ï¸  Migration was skipped"
else
    echo "  âš ï¸  Migration NOT run yet (run: makaron-migrate)"
fi
echo ""

# ============================================================================
# SECTION: Current Theme
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¨ CURRENT THEME"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

THEME_DIR="$MAKARON_PATH/current-theme"
if [ -L "$THEME_DIR" ]; then
    TARGET=$(readlink "$THEME_DIR")
    THEME_NAME=$(basename "$TARGET")
    echo "  âœ“ Current theme: $THEME_NAME"
    echo "    Path: $TARGET"

    # Check mode
    if [ -f "$THEME_DIR/mode" ]; then
        MODE=$(cat "$THEME_DIR/mode")
        echo "    Mode: $MODE"
    fi

    # Check if theme files exist
    echo ""
    echo "  Theme files:"
    [ -f "$THEME_DIR/borders.colors" ] && echo "    âœ“ borders.colors" || echo "    âš ï¸  borders.colors missing"
    [ -f "$THEME_DIR/sketchybar.colors" ] && echo "    âœ“ sketchybar.colors" || echo "    âš ï¸  sketchybar.colors missing"
else
    echo "  âš ï¸  No theme symlink found"
fi
echo ""

# ============================================================================
# SECTION: Summary
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Count issues
ERRORS=0
WARNINGS=0

# Check critical components
[ ! -d "$MAKARON_PATH" ] && ((ERRORS++))
! command -v aerospace &> /dev/null && ((WARNINGS++))
! command -v sketchybar &> /dev/null && ((WARNINGS++))
! command -v borders &> /dev/null && ((WARNINGS++))

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo "  âœ… All systems operational"
elif [ $ERRORS -eq 0 ]; then
    echo "  âš ï¸  $WARNINGS warning(s) found"
else
    echo "  âŒ $ERRORS error(s) and $WARNINGS warning(s) found"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

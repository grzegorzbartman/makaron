#!/bin/bash

# Universal diagnostic script for Makaron system
# Checks configuration, status, and settings across all components

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          Makaron System Diagnostic Tool                     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Set MAKARON_PATH
MAKARON_PATH="${MAKARON_PATH:-$HOME/.local/share/makaron}"

# ============================================================================
# SECTION: System Information
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š SYSTEM INFORMATION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  macOS Version: $(sw_vers -productVersion)"
echo "  MAKARON_PATH: $MAKARON_PATH"
if [ ! -d "$MAKARON_PATH" ]; then
    echo "  âŒ ERROR: MAKARON_PATH directory does not exist!"
else
    echo "  âœ“ MAKARON_PATH exists"
fi
echo ""

# ============================================================================
# SECTION: macOS Settings
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ MACOS SETTINGS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Menu Bar Autohide
MENUBAR_AUTOHIDE=$(defaults read NSGlobalDomain _HIHideMenuBar 2>/dev/null || echo "0")
echo "  Menu Bar Autohide:"
if [ "$MENUBAR_AUTOHIDE" = "1" ]; then
    echo "    Status: âœ“ Enabled (menu bar is hidden)"
    echo "    Value: $MENUBAR_AUTOHIDE"
else
    echo "    Status: â—‹ Disabled (menu bar is visible)"
    echo "    Value: $MENUBAR_AUTOHIDE"
fi
echo ""

# Dock Autohide
DOCK_AUTOHIDE=$(defaults read com.apple.dock autohide 2>/dev/null || echo "0")
echo "  Dock Autohide:"
if [ "$DOCK_AUTOHIDE" = "1" ]; then
    echo "    Status: âœ“ Enabled"
    echo "    Value: $DOCK_AUTOHIDE"
else
    echo "    Status: â—‹ Disabled"
    echo "    Value: $DOCK_AUTOHIDE"
fi
echo ""

# ============================================================================
# SECTION: AeroSpace
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ AEROSPACE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v aerospace &> /dev/null; then
    echo "  âœ“ AeroSpace installed"

    # Check if running
    if pgrep -f "AeroSpace" > /dev/null; then
        echo "  âœ“ AeroSpace is running"

        # Check enable status
        AEROSPACE_ENABLED=$(aerospace list-workspaces --monitor all 2>/dev/null && echo "enabled" || echo "disabled")
        if [ "$AEROSPACE_ENABLED" = "enabled" ]; then
            echo "  âœ“ AeroSpace window management: ENABLED"
        else
            echo "  â—‹ AeroSpace window management: DISABLED"
        fi

        # List windows
        echo ""
        echo "  Current Windows:"
        aerospace list-windows --all 2>/dev/null | while read -r line; do
            echo "    â€¢ $line"
        done || echo "    (Could not retrieve window list)"

        # List workspaces
        echo ""
        echo "  Current Workspaces:"
        aerospace list-workspaces --monitor all 2>/dev/null | while read -r workspace; do
            FOCUSED=$(aerospace list-workspaces --monitor focused 2>/dev/null | grep "^${workspace}$" && echo "â† focused" || echo "")
            echo "    â€¢ $workspace $FOCUSED"
        done || echo "    (Could not retrieve workspace list)"
    else
        echo "  âš ï¸  AeroSpace is NOT running"
    fi

    # Check config
    if [ -L "$HOME/.aerospace.toml" ]; then
        TARGET=$(readlink "$HOME/.aerospace.toml")
        echo ""
        echo "  Config symlink: âœ“"
        echo "    Target: $TARGET"
        if [ "$TARGET" = "$MAKARON_PATH/configs/aerospace/.aerospace.toml" ]; then
            echo "    âœ“ Points to correct location"
        else
            echo "    âš ï¸  Points to different location"
        fi
    else
        echo ""
        echo "  Config symlink: âŒ Not found or not a symlink"
    fi
else
    echo "  âŒ AeroSpace is NOT installed"
fi
echo ""

# ============================================================================
# SECTION: SketchyBar
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š SKETCHYBAR"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v sketchybar &> /dev/null; then
    echo "  âœ“ SketchyBar installed"

    # Check if running
    if pgrep -f "sketchybar" > /dev/null; then
        echo "  âœ“ SketchyBar is running"
    else
        echo "  âš ï¸  SketchyBar is NOT running"
    fi

    # Check brew service
    if brew services list | grep -q "sketchybar.*started"; then
        echo "  âœ“ Brew service: started"
    else
        echo "  â—‹ Brew service: stopped"
    fi

    # Check config
    if [ -L "$HOME/.config/sketchybar" ]; then
        TARGET=$(readlink "$HOME/.config/sketchybar")
        echo "  Config symlink: âœ“"
        echo "    Target: $TARGET"
        if [ "$TARGET" = "$MAKARON_PATH/configs/sketchybar" ]; then
            echo "    âœ“ Points to correct location"
        else
            echo "    âš ï¸  Points to different location"
        fi
    else
        echo "  Config symlink: âŒ Not found or not a symlink"
    fi
else
    echo "  âŒ SketchyBar is NOT installed"
fi
echo ""

# ============================================================================
# SECTION: Borders
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”² BORDERS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v borders &> /dev/null; then
    echo "  âœ“ Borders installed"

    # Check if running
    if pgrep -f "borders" > /dev/null; then
        echo "  âœ“ Borders is running"
    else
        echo "  âš ï¸  Borders is NOT running"
    fi

    # Check brew service
    if brew services list | grep -q "borders.*started"; then
        echo "  âœ“ Brew service: started"
    else
        echo "  â—‹ Brew service: stopped"
    fi
else
    echo "  âŒ Borders is NOT installed"
fi
echo ""

# ============================================================================
# SECTION: SwipeAeroSpace
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‘† SWIPEAEROSPACE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -d "/Applications/SwipeAeroSpace.app" ]; then
    echo "  âœ“ SwipeAeroSpace installed"

    # Check if running
    if pgrep -f "SwipeAeroSpace" > /dev/null; then
        echo "  âœ“ SwipeAeroSpace is running"
    else
        echo "  âš ï¸  SwipeAeroSpace is NOT running"
    fi
else
    echo "  âŒ SwipeAeroSpace is NOT installed"
fi
echo ""

# ============================================================================
# SECTION: Ghostty Terminal
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‘» GHOSTTY TERMINAL"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

GHOSTTY_CONFIG="$MAKARON_PATH/configs/ghostty/config"

if [ -f "$GHOSTTY_CONFIG" ]; then
    echo "  âœ“ Config file exists"
    echo "    Path: $GHOSTTY_CONFIG"

    if [ -w "$GHOSTTY_CONFIG" ]; then
        echo "    âœ“ File is writable"
    else
        echo "    âŒ File is NOT writable!"
    fi

    # Check theme line
    if grep -q "^theme = " "$GHOSTTY_CONFIG"; then
        THEME_LINE=$(grep "^theme = " "$GHOSTTY_CONFIG")
        echo "    Current theme: $THEME_LINE"
    else
        echo "    âš ï¸  No theme line found in config"
    fi
else
    echo "  âŒ Config file does not exist!"
fi

# Check symlink
SYMLINK_PATH="$HOME/.config/ghostty"
if [ -L "$SYMLINK_PATH" ]; then
    TARGET=$(readlink "$SYMLINK_PATH")
    echo "  Config symlink: âœ“"
    echo "    Target: $TARGET"
    if [ "$TARGET" = "$MAKARON_PATH/configs/ghostty" ]; then
        echo "    âœ“ Points to correct location"
    else
        echo "    âš ï¸  Points to different location"
    fi
else
    echo "  Config symlink: âŒ Not found or not a symlink"
fi

# Check GHOSTTY_THEME env var
if [ -n "$GHOSTTY_THEME" ]; then
    echo "  GHOSTTY_THEME env: $GHOSTTY_THEME"
else
    echo "  GHOSTTY_THEME env: (not set)"
fi
echo ""

# ============================================================================
# SECTION: Current Theme
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¨ CURRENT THEME"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

THEME_DIR="$MAKARON_PATH/current-theme"
if [ -L "$THEME_DIR" ]; then
    TARGET=$(readlink "$THEME_DIR")
    THEME_NAME=$(basename "$TARGET")
    echo "  âœ“ Current theme: $THEME_NAME"
    echo "    Path: $TARGET"

    # Check mode
    if [ -f "$THEME_DIR/mode" ]; then
        MODE=$(cat "$THEME_DIR/mode")
        echo "    Mode: $MODE"
    fi

    # Check if theme files exist
    echo ""
    echo "  Theme files:"
    [ -f "$THEME_DIR/borders.colors" ] && echo "    âœ“ borders.colors" || echo "    âš ï¸  borders.colors missing"
    [ -f "$THEME_DIR/sketchybar.colors" ] && echo "    âœ“ sketchybar.colors" || echo "    âš ï¸  sketchybar.colors missing"
else
    echo "  âš ï¸  No theme symlink found"
fi
echo ""

# ============================================================================
# SECTION: Summary
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ SUMMARY"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Count issues
ERRORS=0
WARNINGS=0

# Check critical components
[ ! -d "$MAKARON_PATH" ] && ((ERRORS++))
! command -v aerospace &> /dev/null && ((WARNINGS++))
! command -v sketchybar &> /dev/null && ((WARNINGS++))
! command -v borders &> /dev/null && ((WARNINGS++))

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo "  âœ… All systems operational"
elif [ $ERRORS -eq 0 ]; then
    echo "  âš ï¸  $WARNINGS warning(s) found"
else
    echo "  âŒ $ERRORS error(s) and $WARNINGS warning(s) found"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
